# 哼歌编曲系统使用说明

## 🚀 快速开始

### 1. 启动后端服务
```bash
# Windows用户
双击运行 start_backend.bat

# 或手动启动
python app.py
```

### 2. 打开前端页面
在浏览器中打开 `index.html`

## 🎵 功能使用

### 录音功能
1. **开始录音**: 点击"开始录音"按钮，允许麦克风权限
2. **哼唱旋律**: 对着麦克风哼唱你的旋律
3. **停止录音**: 点击"停止录音"按钮
4. **播放录音**: 点击"播放录音"可回放录音
5. **旋律提取**: 录音完成后自动调用后端API提取旋律

### 示例数据
- **加载示例旋律**: 使用预设的示例旋律
- **生成随机旋律**: 生成随机的C大调旋律

### 编曲功能
1. **生成Strudel代码**: 将旋律转换为可播放的Strudel代码
2. **播放音乐**: 播放生成的音乐（主旋律+和弦）
3. **停止播放**: 停止当前播放
4. **导出代码**: 下载生成的Strudel代码文件

## 🔧 技术架构

### 前端
- **录音**: MediaRecorder API (WebM/Opus格式)
- **可视化**: Web Audio API + Canvas
- **播放**: Strudel + Tone.js 双重引擎
- **通信**: Fetch API 与后端交互

### 后端
- **框架**: Flask + CORS
- **旋律提取**: BasicPitch (Spotify开源)
- **音频处理**: librosa + soundfile
- **格式转换**: WebM → WAV

## 📊 API接口

### 健康检查
```
GET http://localhost:5000/health
```

### 旋律提取
```
POST http://localhost:5000/extract-melody
Content-Type: multipart/form-data
Body: audio file (WebM/WAV/MP3)
```

### 响应格式
```json
{
  "success": true,
  "message": "成功提取到 8 个音符",
  "notes": [
    {
      "pitch": 60,
      "start_time": 0.0,
      "duration": 0.5,
      "velocity": 80
    }
  ],
  "total_duration": 4.0
}
```

## 🐛 故障排除

### 录音问题
- **权限被拒绝**: 确保浏览器允许麦克风权限
- **无法录音**: 检查麦克风是否正常工作
- **HTTPS要求**: 某些浏览器要求HTTPS才能录音

### 后端问题
- **服务启动失败**: 检查Python版本(3.8+)和依赖安装
- **BasicPitch加载慢**: 首次运行需要下载模型，请耐心等待
- **端口占用**: 确保5000端口未被占用

### 旋律提取问题
- **未检测到音符**: 尝试哼唱更清晰的音调
- **提取失败**: 检查录音质量，避免背景噪音
- **网络错误**: 确保后端服务正在运行

## 🎯 最佳实践

### 录音技巧
1. **环境安静**: 选择安静的环境录音
2. **距离适中**: 距离麦克风20-30cm
3. **音调清晰**: 哼唱时保持音调稳定
4. **时长适中**: 建议3-10秒的录音

### 旋律建议
1. **简单旋律**: 从简单的音阶开始
2. **节奏稳定**: 保持稳定的节拍
3. **音域适中**: 在C4-C6范围内效果最佳
4. **避免和声**: 单声部旋律效果更好

## 📈 性能优化

### 前端优化
- 使用Web Workers处理大量数据
- 音频可视化使用requestAnimationFrame
- 及时清理音频资源

### 后端优化
- 音频预处理减少噪音
- 模型缓存提高响应速度
- 临时文件及时清理

## 🔮 未来计划

1. **智能编曲**: 更复杂的和弦进行和节奏
2. **多轨合成**: 鼓组、贝斯、弦乐等
3. **音色选择**: 不同乐器的音色
4. **实时处理**: 实时录音和分析
5. **云端部署**: 支持在线使用

## 📞 技术支持

如遇到问题，请检查：
1. 浏览器控制台错误信息
2. 后端服务日志
3. 网络连接状态
4. 音频设备状态

---

**开发团队**: 哼歌编曲项目组  
**版本**: v1.0.0  
**更新时间**: 2024-12-19

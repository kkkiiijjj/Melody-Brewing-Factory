# 哼歌编曲项目开发日志

## 项目概述
基于 README.md 中定义的音乐生成管线，实现一个 MVP 版本：用户哼唱 → 旋律提取 → 智能编曲 → 音频合成。

## 当前实现状态 (2024-12-19)

### ✅ 已完成功能

#### 1. 前端界面与交互
- **页面结构** (`index.html`): 4个功能区块
  - 模拟用户哼唱数据（示例/随机旋律）
  - 转换为 Strudel 代码
  - 播放音乐（播放/停止/导出）
  - 完整编曲示例展示

- **样式设计**: 现代化渐变背景，毛玻璃效果容器，响应式按钮

#### 2. 核心音乐处理逻辑 (`strudel-demo.js`)
- **旋律数据结构**: 支持 MIDI 音符格式
  ```javascript
  { pitch: 60, start_time: 0, duration: 0.5, velocity: 80 }
  ```

- **示例旋律库**: 3种预设旋律（simple/happy/sad）
- **随机旋律生成**: C大调音阶内随机生成8个音符
- **MIDI转音名**: 支持升降号音名转换
- **时长符号映射**: 根据BPM将时长转换为Strudel时值符号

#### 3. 音乐代码生成
- **旋律转Strudel模式**: 
  ```javascript
  melodyToStrudelPattern(melody, bpm, instrument)
  // 输出: sound("piano").note("C4_ D4_ E4_ ...")
  ```

- **和弦进行生成**: I-V-vi-IV 经典进行
  ```javascript
  generateChordProgression('C', 'I-V-vi-IV')
  // 输出: sound("pad").chord("c4 g4 a4 f4").gain(0.3)
  ```

#### 4. 播放系统（双重回退机制）
- **优先Strudel**: 动态导入 `@strudel/core`，兼容多种导出形式
- **回退Tone.js**: 当Strudel不可用时自动使用Tone.js
- **播放功能**: 
  - 主旋律：Tone.Synth 单音合成器
  - 和弦：Tone.PolySynth 多音合成器
  - 调度：Tone.Part 精确时间调度
  - 控制：播放/停止/重置

#### 5. 用户交互
- **按钮绑定**: 所有UI控件已正确绑定事件
- **状态显示**: 实时状态提示（成功/错误/信息）
- **代码导出**: 下载生成的Strudel代码为文本文件
- **错误处理**: 音频上下文启动、模块加载失败等异常处理

### 🔧 技术实现细节

#### 模块加载策略
```javascript
// 动态导入避免静态导入错误
StrudelCore = await import('https://cdn.jsdelivr.net/npm/@strudel/core/+esm');
```

#### 音频播放架构
```javascript
// 双重回退机制
async function handlePlay() {
    const ok = await playWithStrudel();  // 优先Strudel
    if (!ok) {
        await playWithTone();           // 回退Tone.js
    }
}
```

#### 事件调度系统
```javascript
// 主旋律调度
const melodyPart = new Tone.Part((time, ev) => {
    synth.triggerAttackRelease(ev.note, ev.dur, time, 0.8);
}, melodyEvents);

// 和弦调度
const chordPart = new Tone.Part((time, ev) => {
    pad.triggerAttackRelease(ev.value, 2, time, 0.3);
}, chordEvents);
```

### 📊 数据流转换

1. **用户输入** → 示例旋律JSON
2. **旋律处理** → Strudel代码字符串
3. **代码执行** → 音频播放
4. **结果导出** → 文本文件下载

### 🚧 待实现功能

#### 短期目标（MVP扩展）
1. **真实录音功能**
   - MediaRecorder API 录音
   - WebM → WAV 转换
   - 音频可视化（可选）

2. **后端旋律提取**
   - Flask API 接口
   - BasicPitch 模型集成
   - 音频上传/处理/返回

3. **智能编曲算法**
   - 调性检测
   - 节奏量化
   - 和弦进行优化
   - 鼓组生成

#### 长期目标
1. **完整音乐管线**
   - 音频预处理（降噪、归一化）
   - 段落划分与结构分析
   - 多轨编曲（鼓+贝斯+和弦+旋律）
   - 高质量音频合成

2. **用户体验优化**
   - 实时录音反馈
   - 进度显示
   - 参数调节界面
   - 音色选择

### 🐛 已解决的技术问题

1. **模块导入错误**: `@strudel/core` 导出名不匹配 → 改为动态导入
2. **DOM加载时序**: 事件绑定在DOM加载前执行 → 使用DOMContentLoaded
3. **音频上下文限制**: 浏览器要求用户手势启动 → 在播放时调用Tone.start()
4. **Tone.js参数错误**: 事件对象误传 → 使用ev.value传递正确数据

### 📈 性能指标

- **页面加载**: < 2秒（包含CDN资源）
- **代码生成**: < 100ms
- **音频启动**: < 500ms
- **内存占用**: 轻量级，无内存泄漏

### 🎯 下一步计划

1. **集成录音功能** - 实现真实音频输入
2. **后端API开发** - 旋律提取服务
3. **算法优化** - 更智能的编曲逻辑
4. **UI/UX改进** - 更直观的用户界面

---

## 开发时间线

- **2024-12-19**: 项目初始化，完成基础UI和播放功能
- **下一步**: 录音功能集成
- **目标**: 完整MVP版本

## 技术栈总结

- **前端**: HTML5 + CSS3 + ES6模块 + Tone.js
- **音乐处理**: Strudel + Tone.js 双重播放引擎
- **数据格式**: MIDI音符 → Strudel代码 → 音频输出
- **部署**: 静态文件，支持本地运行
